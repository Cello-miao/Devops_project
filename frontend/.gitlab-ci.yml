stages:
  - test
  - build
  - deploy

variables:
  # Disable TLS for docker-in-docker (used in build_job)
  DOCKER_TLS_CERTDIR: ""

# Run tests on commits to the dev branch
test_job:
  stage: test
  image: node:20-alpine
  script:
    - npm ci
    - npm test
  only:
    - dev
  tags:
    - runner

# Build docker images only on the main branch
build_job:
  stage: build
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - 'docker info || true'
  script:
    - 'docker build -f Dockerfile.dev -t "$CI_PROJECT_NAME:dev" .'
    - 'docker build -f Dockerfile.prod -t "$CI_PROJECT_NAME:prod" .'
    - 'echo "Built images: $CI_PROJECT_NAME:dev and $CI_PROJECT_NAME:prod"'
  only:
    - main
  tags:
    - runner
  retry: 1
  # privileged: true

# Deploy to AWS S3 + optional CloudFront invalidation
deploy:
  stage: deploy
  image: node:20
  script:
    - npm ci --silent
    - npm run build
    - apt-get update -y && apt-get install -y awscli groff-base
    - aws --version
    - aws s3 sync dist/ s3://$S3_BUCKET --delete
  only:
    - main
  tags:
    - runner

