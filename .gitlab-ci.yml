---
# GitLab CI/CD Pipeline for DevOps Project

stages:
  - build
  - test
  - push
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

services:
  - docker:27-dind

cache:
  paths:
    - frontend/node_modules/
    - backend/_build/
    - backend/deps/

before_script:
  - docker info || true

# Build frontend Docker image
build_frontend:
  stage: build
  image: docker:27
  script:
    - docker build -t "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA"
      -f frontend/Dockerfile frontend/
  only:
    - branches

# Build backend Docker image
build_backend:
  stage: build
  image: docker:27
  script:
    - docker build -t "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
      -f backend/Dockerfile backend/
  only:
    - branches

# Test backend with Elixir
test_backend:
  stage: test
  image: elixir:1.17-alpine
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_DB: signin_project_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_HOST_AUTH_METHOD: trust
    DB_HOST: postgres
    DB_USER: postgres
    DB_PASSWORD: postgres
    DB_NAME: signin_project_test
    MIX_ENV: test
  script:
    - apk add --no-cache build-base git postgresql-client
    - echo "Waiting for postgres to be ready..."
    - until pg_isready -h postgres -U postgres; do sleep 1; done
    - cd backend
    - mix local.hex --force
    - mix local.rebar --force
    - mix deps.get
    - mix ecto.create
    - mix ecto.migrate
    - mix test
  only:
    - branches

# Test frontend with Node.js
test_frontend:
  stage: test
  image: node:20-alpine
  script:
    - cd frontend
    - npm ci
    - npm run test --if-present
  only:
    - branches

# Build and push images to registry (main branch only)
push_frontend:
  stage: push
  image: docker:27
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login
      -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker build -t "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA"
      -t "$CI_REGISTRY_IMAGE/frontend:latest"
      -f frontend/Dockerfile frontend/
    - docker push "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA"
    - docker push "$CI_REGISTRY_IMAGE/frontend:latest"
  only:
    - main

push_backend:
  stage: push
  image: docker:27
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login
      -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker build -t "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
      -t "$CI_REGISTRY_IMAGE/backend:latest"
      -f backend/Dockerfile backend/
    - docker push "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
    - docker push "$CI_REGISTRY_IMAGE/backend:latest"
  only:
    - main

# Manual deployment to production
deploy_prod:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploy to production server"
    - echo "Configure SSH and deployment script as needed"
  when: manual
  only:
    - main
